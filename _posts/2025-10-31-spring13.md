---
layout: single
title: "Login 기능구현"
excerpt: "DB에 있던 유저정보를 꺼내기, loadUserByUsername함수완성, 테이블에서 특정 컬럼 값 가져오기, 권한, Controller에서 현재 로그인 정보 출력, HTML에서 유저정보 출력(Thymeleaf), auth 변수에 유저정보 추가(extends), 타입캐스팅
categories: SpringBoot
tag: SpringBoot
toc: true
published: true
---


저번시간까지는 회원가입기능을 구현해봤으니 이번에는 로그인기능을 구현해보자  
1. 로그인페이지 만들고
2. 폼으로 로그인 정보 전송하고(POST방식)
3. 전송한 정보와 == DB에 있던 비번 비교해서 일치하면 로그인되는데 Springsecurity가  
이것까진 몰라서 DB에 있는 비번 꺼내오는 코드를 직접 짜주면 된다.  

그럼 한번 로그인기능을 구현해보자

## 로그인페이지
```html
<body>
    <form action="/login" method="POST">
        <input name="username">
        <input name="password" type="password">
        <button type="submit">전송</button>
    </form>
</body>
```

로그인 html만들어주고 

```java
 @GetMapping("/login")
    public String login() {
        return "login.html";
    }
```

Springsecurity사용할 떄 주의할 점은
- 아이디는 username, 패스워드는 password 이름으로 전송

- 전송버튼 누르면 /login으로 POST 요청 날려야됨.

폼(post방식)으로 로그인 설정하는 코드는 

![Spring 이미지](/assets/images/spring13.png)

위의 네모박스(빨강)에 있는 코드를 추가하면 된다.   
그리고 로그인html에 
```html
<div th:if="${param.error}">
  <h4>아이디나 비번이 일치하지않습니다.</h4>
</div> 
```

## DB에 있던 유저정보를 꺼내기
일단 MyUserDetailsService 클라스 하나만들고
```java
@Service
public class MyUserDetailsService implements UserDetailsService {

  @Override
  public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    //DB에서 username을 불러온다음
    //return new User(username, password, 권한) 
  }
} 
```

간단하게 동작흐름 그림으로 보면...
![Spring 이미지](/assets/images/spring131.png)
간략히 요약하면 폼으로 **username, password** 를 전송하면
여러절차를 거쳐서 **UserDetailsService** 오는데 이제 회원정보를 DB에서 꺼내오면 되는데 그건 **AutenticationProvider** 에서 (유저가제출한비번 == DB에 있는 비번 조회함) 

### MyUserDetailService요약
1. 로그인 폼(아이디/비번) 전송 
2. 유저가제출한비번 == DB에 있는 비번 조회함 근데 Springsecurity가  
이것까진 몰라서 DB에 있는 비번 꺼내오는 코드를 직접 짜줘야 함
3. 그거 코딩하는 곳이  **MyUserDetailService** class임
4. loadUserByUsername() 함수만들고 거기서 **username/password/권한** 이런걸 담아서 return 해주면 비번검사 끝!x

라이브러리는 문법쓰는건 외우지말고 흐름만 익히고 복붙해서 쓰자!!

## interface란?
어떤 클래스만들 때 특정 함수 이름들을 꼭 만들게 강제하고 싶을 때는 interface 문법을 사용함 @Override해서 가져올 수 있음.

![Spring 이미지](/assets/images/spring132.png)

위의 사진을 보면 **UserDetailsService interface**에 **loadUserByUsername**함수가 있는 걸 볼 수 있다.

위의 함수를 내가 만든 **MyUserDetailsService**에서 쓰려면 **UserDetailsService**를 **implements**하고  
```java
@Service
public class MyUserDetailsService implements UserDetailsService {

  @Override
  public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    //DB에서 username을 불러온다음
    //return new User(username, password, 권한) 
  }
} 
```  
이런식으로 **Override**이런식으로 사용해야 된다.

## loadUserByUsername 함수

방금 만든 **loadUserByUsername**이라는 함수에다가 **username 파라미터** 추가하면
유저가 로그인시 제출한 username이 들어옴
그다음 DB에서 일치하는 회원을 찾아와서
그 회원정보들을 new User()에 담아서 return 해주면 끝

### 테이블에서 특정 컬럼 값 가져오기
![Spring 이미지](/assets/images/spring133.png)
테이블에서 column하나 찾고 싶으면 **JPA문법**으로 .findById(16)이렇게하면
id가 16번째인 행을 찾아오는데 지금은  **.findByUsername()**으로 찾아와야 한다.
근데 이런 함수는 만들어져 있이 않아서 직접 만들어야함

근데 그거 코딩하는 곳이 바로 **MemberRepository**다. 

```java
public interface MemberRepository extends JpaRepository<Member, Long> {

    Optional<Member> findByUsername(String username);

} 
```
findBy컬럼명(파라미터); 이렇게 만들면 컬려명에 파라미터에 들어있는 행을  
찾아오는 함수를 만들어준다.  
행을 못 찾을 수 있기때문에 Optional타입으로 하자.

이런거를 **Derived Query Methods** 라고 부른다.

구글에 검색해보면....
![Spring 이미지](/assets/images/spring134.png)

DB에서 username을 가진 유저를 찾아와서
**return new User(유저아이디, 비번, 권한)** 하면 끝!!

```java
  @Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    var result = memberRepository.findByUsername(username);
    if (result.isEmpty()){
      throw new UsernameNotFoundException("아이디 존재하지않습니다.");
    }
    var user = result.get();
    return new User(user.getUsername(), user.getPassword(), 권한);

  } 
```
Member테이블 중에서 **username column**에서  **String username**가 있는 컬럼을 찾고 
만약 없으면 에러메세지로 "아이디 존재하지않습니다." 있으면 user정보(user.getUsername(),user.getPassword, authorities)를 return ➤ 유저아디,비번 일치하면 유저가 제출한거랑 조회하고 맞으면 통과.

## 권한(authorities)
유저의 권한 이 몬지 [권한1,권한2,.......] 리스트형이 좋음
```java
List<GrantedAuthority> authorities = new ArrayList<>();
authorities.add(new SimpleGrantedAuthority("일반유저"));
```
 **일반유저**는 그냥 메모임 이 유저가 어떤 유저인지....
 나중에 API에서 현재의 권한 출력가가능.

 이제 로그인 해서 **개발자도구 application**탭가면 **cookie**가 생성됨
 사이트 이용시 쿠기가 전송되는데 서버에서 그걸보고 로그인여부 판단.

 ## MyPage만들기

 ```java
 @GetMapping("/my-page")
public String myPage() {
    return "mypage.html";
}
 ```

 근데 마이페이지는 로그인한 유저만 볼 수 있어야 되느건아님?
 
 ### Controller에서 현재 로그인 정보 출력
 ```java
 @GetMapping("/my-page")
  public String myPage(Authentication auth) {
    System.out.println(auth);
    System.out.println(auth.getName()); //아이디출력가능
    System.out.println(auth.isAuthenticated()); //로그인여부 검사가능
    System.out.println(auth.getAuthorities().contains(new SimpleGrantedAuthority("일반유저")));
    return "mypage.html";
  } 
 ```

 마에페이지접속하면 console창에
 ![Spring 이미지](/assets/images/spring135.png)
 **로그인한 유저정보**가 출력되는걸 볼 수 있다.

 ### HTML에서 유저정보 출력(Thymeleaf)
 ```html
    <div sec:authentication="principal"></div>
    <div sec:authentication="principal.username"></div>
    <span sec:authorize="hasAuthority('일반유저')">일반유저만 보여주셈</span>
    <div sec:authorize="isAuthenticated()">
        로그인된 사람만 보여주셈
    </div>
 ```

 **sec:authentication** 이런 문법을 사용하면 현재 로그인 중인 유저정보를 쉽게 출력가능 !!!

  ![Spring 이미지](/assets/images/spring136.png)

  ### auth 변수에 유저정보 추가(extends)
  일단 현재 출력가능한 유저정보는 username,password,authorities뿐인데 그 이유는  
  
  ```java
  public UserDetails loadUserByUsername()  {
  (생략)
  return new User(result.username, result.password, authorities);
  }
  ```
  이미 User 클래스는 라이브러리에 3개의 파라미터까지만 정보를 넣을 수 있게 만들어놔서 
  내 테이블에있는 id,displayName을 출력할 수 있다 그러나 아예 방법이 없는건 아니다.

  User클래스에 있는 변수 함수를 다 복사해오는 방법으로 할 수 있는데 그렇게 하려면 코드를

  ```java
  @Service
@RequiredArgsConstructor
public class MyUserDetailsService implements UserDetailsService {

    private final MemberRepository memberRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // DB에서 username을 가진 유저를 찾아와서
        // return new User(유저아이디, 비번, 권한) 해주세요
        Optional<Member> result = memberRepository.findByUsername(username);
        if (result.isEmpty()) {
            throw new UsernameNotFoundException("no id");
        }
        Member user = result.get();
        List<GrantedAuthority> authorities = new ArrayList<>();
        authorities.add(new SimpleGrantedAuthority("일반유저"));
        CustomUser customUser = new CustomUser(user.getUsername(), user.getPassword(), authorities);
        customUser.displayName = user.getDisplayName();

        return customUser;
    }
}

class CustomUser extends User {
    public String displayName;

    public CustomUser(String username, String password, Collection<? extends GrantedAuthority> authorities) {
        super(username, password, authorities);

    }

}
  ```
  이렇게 User와 비슷한 CustomUser를 하나 만들면 되는데 그럴때 꼭
  **extends**를 꼭 사용해야되는데 근데 꼭 **super**라는  문법을 함꼐서야한다.
  super는 **복사한 클래스의 constructor**이다
  클래스를 복사해올 때 그 원본 클래스의 constructor기능을 똑같이해주는게 중요

  컨트롤러에서 **auth.getPrincipal()** 출**력하면 사용가능
  **auth.getPrincipal().displayName** 이런거 쓰면 되는데 안됄텐데 
  왜냐면 타입이 **Object**라서 점찍어서 displayName 출력이 안된다고합니다.
  그럴 땐 타입을 맘대로 변환하는 것도 가능!!
  타입캐스팅이라고 부름 

  ```java
    @GetMapping("/my-page")
    public String myPage(Authentication auth) {
        CustomUser result = (CustomUser) auth.getPrincipal();
        System.out.println(result.displayName);
        return "mypage.html";

    }
  ```

  mypage로 접속해보면 콘솔창에 접속하면
  ![Spring 이미지](/assets/images/spring137.png)
  ![Spring 이미지](/assets/images/spring138.png)
  **displayname**인 **park**이 출력되는걸 볼 수 있다.


  ## 로그아웃 및 세션

  ### 로그아웃
  ```java
  http.logout( logout -> logout.logoutUrl("/logout") ); 
  ```
  SecurityConfig파일에서 설정(get요청으로 로그아웃)

  ### 세션
  ```java
server.servlet.session.timeout=5s
server.servlet.session.cookie.max-age=5s 
  ```

application.properties 파일에 코드 추가해주면 됩니다.

## 결론

오늘의 결론 : 

1. 남이 만든 클래스를 수정하고 싶으면 원본을 수정하는 것 보다는 **extends** 로 복사해서 새로 클래스를 만드는 방법도 있습니다.

2. extends로 복사할 때 **super**를 사용해서 constructor도 복사하자.

3. Object타입은 **타입캐스팅**!!

4. 세션 유효기간 설정도 가능


















